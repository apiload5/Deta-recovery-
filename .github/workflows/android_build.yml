name: KivyMD Android Build & Debug

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_apk:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python Dependencies for Buildozer
        # KivyMD aur Buildozer ki zaroorat ke mutabiq libraries install karen
        run: |
          pip install KivyMD buildozer google-genai PyGithub

      - name: Build KivyMD APK with Buildozer
        # Kivy ke complex environment ko handle karta hai
        id: build
        uses: kivy/buildozer-action@v1
        with:
          command: buildozer android debug 

      - name: Upload APK as Artifact
        # Agar build successful ho jaye to APK ko save karen
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: KivyMD-APK-${{ github.sha }}
          path: bin/*.apk
          retention-days: 7

      - name: Debug Build Error with Gemini (If Build Fails)
        # Yeh step sirf tab chalaega jab build fail ho jaye
        if: failure()
        run: |
          echo "Build failed. Starting Gemini diagnosis..."
          python debug_script.py
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Buildozer ka default log path
          BUILD_LOG_PATH: .buildozer/android/platform/build-armeabi-v7a/dists/*/build/logs/log.txt 
          # Note: Buildozer ka log path environment ke hisaab se thoda badal sakta hai
